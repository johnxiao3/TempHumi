#include "Fx2.h"
#include "fx2regs.h"

#include "stdlib.h"
#include "string.h"

#include "iic_comm.h"

#include "ssd1306.h"
	
const code au8Font8x8[]= {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,       // ASCII -  32
    0x00,0x00,0x00,0x5F,0x5F,0x00,0x00,0x00,       // ASCII -  33
    0x00,0x00,0x03,0x07,0x00,0x07,0x03,0x00,       // ASCII -  34
    0x00,0x10,0x74,0x1C,0x77,0x1C,0x17,0x04,       // ASCII -  35
    0x00,0x24,0x2E,0x2A,0x7F,0x2A,0x3A,0x10,       // ASCII -  36
    0x00,0x4C,0x6A,0x76,0x1A,0x6A,0x56,0x33,       // ASCII -  37
    0x00,0x30,0x7A,0x4F,0x5D,0x37,0x7A,0x48,       // ASCII -  38
    0x00,0x00,0x04,0x07,0x03,0x00,0x00,0x00,       // ASCII -  39
    0x00,0x00,0x00,0x1C,0x3E,0x63,0x41,0x00,       // ASCII -  40
    0x00,0x00,0x41,0x63,0x3E,0x1C,0x00,0x00,       // ASCII -  41
    0x00,0x08,0x2A,0x3E,0x1C,0x3E,0x2A,0x08,       // ASCII -  42
    0x00,0x08,0x08,0x3E,0x3E,0x08,0x08,0x00,       // ASCII -  43
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00,       // ASCII -  44
    0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,       // ASCII -  45
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00,       // ASCII -  46
    0x00,0x60,0x30,0x18,0x0C,0x06,0x03,0x01,       // ASCII -  47
    0x00,0x1C,0x3E,0x61,0x43,0x3E,0x1C,0x00,       // ASCII -  48
    0x00,0x00,0x44,0x7F,0x7F,0x40,0x00,0x00,       // ASCII -  49
    0x00,0x46,0x67,0x71,0x59,0x4F,0x66,0x00,       // ASCII -  50
    0x00,0x22,0x63,0x49,0x4D,0x7F,0x32,0x00,       // ASCII -  51
    0x00,0x18,0x1C,0x52,0x7F,0x7F,0x50,0x00,       // ASCII -  52
    0x00,0x2F,0x6F,0x45,0x45,0x7D,0x39,0x00,       // ASCII -  53
    0x00,0x3C,0x7E,0x4B,0x49,0x79,0x30,0x00,       // ASCII -  54
    0x00,0x07,0x43,0x71,0x7D,0x0F,0x03,0x00,       // ASCII -  55
    0x00,0x36,0x7F,0x4D,0x59,0x7F,0x36,0x00,       // ASCII -  56
    0x00,0x06,0x4F,0x49,0x69,0x3F,0x1E,0x00,       // ASCII -  57
    0x00,0x00,0x00,0x66,0x66,0x00,0x00,0x00,       // ASCII -  58
    0x00,0x00,0x00,0x66,0x66,0x00,0x00,0x00,       // ASCII -  59
    0x00,0x00,0x08,0x1C,0x36,0x63,0x41,0x00,       // ASCII -  60
    0x00,0x14,0x14,0x14,0x14,0x14,0x14,0x00,       // ASCII -  61
    0x00,0x00,0x41,0x63,0x36,0x1C,0x08,0x00,       // ASCII -  62
    0x00,0x02,0x07,0x51,0x59,0x0F,0x06,0x00,       // ASCII -  63
    0x00,0x3E,0x41,0x5D,0x55,0x5D,0x51,0x1E,       // ASCII -  64
    0x00,0x40,0x70,0x1D,0x17,0x1F,0x78,0x60,       // ASCII -  65
    0x00,0x41,0x7F,0x7F,0x49,0x4F,0x7E,0x30,       // ASCII -  66
    0x00,0x1C,0x3E,0x63,0x41,0x41,0x42,0x27,       // ASCII -  67
    0x00,0x41,0x7F,0x7F,0x41,0x63,0x3E,0x1C,       // ASCII -  68
    0x00,0x41,0x7F,0x7F,0x49,0x5D,0x41,0x63,       // ASCII -  69
    0x00,0x41,0x7F,0x7F,0x49,0x1D,0x01,0x03,       // ASCII -  70
    0x00,0x1C,0x3E,0x63,0x41,0x51,0x72,0x77,       // ASCII -  71
    0x00,0x7F,0x7F,0x08,0x08,0x7F,0x7F,0x00,       // ASCII -  72
    0x00,0x00,0x41,0x7F,0x7F,0x41,0x00,0x00,       // ASCII -  73
    0x00,0x30,0x70,0x41,0x41,0x7F,0x3F,0x01,       // ASCII -  74
    0x00,0x7F,0x7F,0x08,0x1C,0x77,0x63,0x41,       // ASCII -  75
    0x00,0x41,0x7F,0x7F,0x41,0x40,0x60,0x70,       // ASCII -  76
    0x00,0x7F,0x7E,0x0C,0x18,0x0C,0x7E,0x7F,       // ASCII -  77
    0x00,0x7F,0x7E,0x0C,0x18,0x30,0x7F,0x7F,       // ASCII -  78
    0x00,0x1C,0x3E,0x63,0x41,0x63,0x3E,0x1C,       // ASCII -  79
    0x00,0x41,0x7F,0x7F,0x49,0x09,0x0F,0x06,       // ASCII -  80
    0x00,0x1C,0x3E,0x63,0x51,0x63,0x3E,0x1C,       // ASCII -  81
    0x00,0x7F,0x7F,0x09,0x19,0x7F,0x66,0x40,       // ASCII -  82
    0x00,0x66,0x6F,0x4D,0x59,0x7B,0x33,0x00,       // ASCII -  83
    0x00,0x03,0x41,0x7F,0x7F,0x41,0x03,0x00,       // ASCII -  84
    0x00,0x3F,0x7F,0x40,0x40,0x40,0x7F,0x3F,       // ASCII -  85
    0x00,0x03,0x0F,0x3D,0x70,0x1D,0x07,0x01,       // ASCII -  86
    0x00,0x0F,0x7F,0x30,0x1C,0x30,0x7F,0x0F,       // ASCII -  87
    0x00,0x63,0x77,0x1C,0x1C,0x77,0x63,0x00,       // ASCII -  88
    0x01,0x03,0x47,0x7C,0x78,0x47,0x03,0x01,       // ASCII -  89
    0x00,0x67,0x73,0x59,0x4D,0x67,0x73,0x00,       // ASCII -  90
    0x00,0x00,0x00,0x7F,0x7F,0x41,0x41,0x00,       // ASCII -  91
    0x00,0x01,0x03,0x06,0x0C,0x18,0x30,0x60,       // ASCII -  92
    0x00,0x00,0x41,0x41,0x7F,0x7F,0x00,0x00,       // ASCII -  93
    0x00,0x00,0x04,0x06,0x03,0x06,0x04,0x00,       // ASCII -  94
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,       // ASCII -  95
    0x00,0x00,0x01,0x03,0x06,0x04,0x00,0x00,       // ASCII -  96
    0x00,0x68,0x6C,0x54,0x54,0x3C,0x78,0x40,       // ASCII -  97
    0x00,0x41,0x7F,0x3F,0x6C,0x44,0x7C,0x38,       // ASCII -  98
    0x00,0x38,0x7C,0x44,0x44,0x6C,0x2C,0x00,       // ASCII -  99
    0x00,0x38,0x7C,0x44,0x49,0x3F,0x7F,0x40,       // ASCII - 100
    0x00,0x38,0x7C,0x54,0x54,0x5C,0x58,0x00,       // ASCII - 101
    0x00,0x00,0x48,0x7E,0x7F,0x49,0x0B,0x02,       // ASCII - 102
    0x00,0x48,0x7C,0x34,0x34,0x2C,0x68,0x44,       // ASCII - 103
    0x00,0x41,0x7F,0x7F,0x08,0x04,0x7C,0x78,       // ASCII - 104
    0x00,0x00,0x44,0x7D,0x7D,0x40,0x00,0x00,       // ASCII - 105
    0x00,0x60,0x60,0x04,0x7D,0x7D,0x00,0x00,       // ASCII - 106
    0x00,0x41,0x7F,0x7F,0x10,0x78,0x6C,0x44,       // ASCII - 107
    0x00,0x00,0x41,0x7F,0x7F,0x40,0x00,0x00,       // ASCII - 108
    0x00,0x7C,0x7C,0x0C,0x78,0x0C,0x7C,0x78,       // ASCII - 109
    0x00,0x44,0x7C,0x7C,0x08,0x04,0x7C,0x78,       // ASCII - 110
    0x00,0x38,0x7C,0x44,0x44,0x7C,0x38,0x00,       // ASCII - 111
    0x00,0x04,0x7C,0x78,0x24,0x24,0x3C,0x18,       // ASCII - 112
    0x00,0x18,0x3C,0x24,0x24,0x78,0x7C,0x00,       // ASCII - 113
    0x00,0x44,0x7C,0x78,0x4C,0x04,0x1C,0x18,       // ASCII - 114
    0x00,0x48,0x5C,0x5C,0x74,0x74,0x24,0x00,       // ASCII - 115
    0x00,0x00,0x04,0x3E,0x7F,0x44,0x24,0x00,       // ASCII - 116
    0x00,0x3C,0x7C,0x40,0x40,0x3C,0x7C,0x40,       // ASCII - 117
    0x00,0x04,0x1C,0x3C,0x60,0x30,0x1C,0x04,       // ASCII - 118
    0x00,0x1C,0x7C,0x30,0x1C,0x30,0x7C,0x1C,       // ASCII - 119
    0x00,0x44,0x6C,0x3C,0x10,0x78,0x6C,0x44,       // ASCII - 120
    0x00,0x44,0x4C,0x1C,0x70,0x64,0x1C,0x0C,       // ASCII - 121
    0x00,0x4C,0x64,0x74,0x5C,0x4C,0x64,0x00,       // ASCII - 122
    0x00,0x08,0x08,0x3E,0x77,0x41,0x41,0x00,       // ASCII - 123
    0x00,0x00,0x00,0x7F,0x7F,0x00,0x00,0x00,       // ASCII - 124
    0x00,0x41,0x41,0x77,0x3E,0x08,0x08,0x00,       // ASCII - 125
    0x00,0x02,0x01,0x01,0x03,0x02,0x02,0x01,       // ASCII - 126
    0x00,0x60,0x78,0x4E,0x47,0x5E,0x78,0x60,       // ASCII - 127
    0x00,0x1C,0x3E,0x23,0x41,0x41,0x42,0x27,       // ASCII - 128
    0x00,0x3D,0x7D,0x40,0x41,0x3D,0x7C,0x40,       // ASCII - 129
};	   		

		
unsigned char* m_pFramebuffer;

void writeCommand(unsigned char cmd)
{
	I2CStart();
	I2CSend(0x78);  //Slave address,SA0=0
	I2CSend(0x00);	//write command
	I2CSend(cmd);
	I2CStop();
}	   

void writeData(unsigned char cmd)
{
	I2CStart();
	I2CSend(0x78);  //Slave address,SA0=0
	I2CSend(0x40);	//write data
	I2CSend(cmd);
	I2CStop();
}
void ssd1306_initalize()
{

	//m_pFramebuffer = (unsigned char*)malloc(SSD1306_FBSIZE);
	//if(m_pFramebuffer == 0){
	//	return;
	//}
	//memset(m_pFramebuffer,0,SSD1306_FBSIZE);//clear it.
	//write command to the screen registers.
	writeCommand(SSD1306_CMD_DISPLAY_OFF);//0xAE
	writeCommand(0xD5);//Set Memory Addressing Mode
	writeCommand(0x80);//00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
	writeCommand(0xA8);//Set Page Start Address for Page Addressing Mode,0-7
	writeCommand(0x3F);//--set segment re-map 0 to 127
	writeCommand(0xD3);//--set multiplex ratio(1 to 64)
	writeCommand(0x00);//
	writeCommand(0x40);//0xa4,Output follows RAM content;0xa5,Output ignores RAM content
	writeCommand(0x8D);//-set display offset
	writeCommand(0x14);//-not offset
	writeCommand(0x20);//--set display clock divide ratio/oscillator frequency
	writeCommand(0x00);//--set divide ratio
	writeCommand(0xA1);//--set pre-charge period
	writeCommand(0xC8);//
	writeCommand(0xDA);//--set com pins hardware configuration
	writeCommand(0x12);//--set vcomh
	writeCommand(0x81);//0x20,0.77xVcc
	writeCommand(0xCF);//--set DC-DC enable
	writeCommand(0xD9);
	writeCommand(0xF1);
	writeCommand(0xDB);
	writeCommand(0x40);
	writeCommand(0xA4);
	writeCommand(0xA6);
	writeCommand(SSD1306_CMD_DISPLAY_ON);//--0XAF

	//delay(10);//wait for the screen loaded.
}

void ssd1306_clear()
{
	int i;

	writeCommand(SSD1306_SETLOWCOLUMN | 0x0);  // low col = 0
    writeCommand(SSD1306_SETHIGHCOLUMN | 0x0);  // hi col = 0
    writeCommand(SSD1306_SETSTARTLINE | 0x0); // line #0
	writeCommand(0xb0);
	
    for (i=0; i<1024; i++) 
    {
      writeData(0x00);
    }
}
		 
void ssd1306_printchar(unsigned char dat)
{
	unsigned char i;
	for (i=0; i<8; i++) 
    {
      writeData(au8Font8x8[(dat-32)*8+i]);
    }
}

void ssd1306_draw()
{
	int i,j;

	writeCommand(SSD1306_SETLOWCOLUMN | 0x0);  // low col = 0
    writeCommand(SSD1306_SETHIGHCOLUMN | 0x0);  // hi col = 0
    writeCommand(SSD1306_SETSTARTLINE | 0x0); // line #0

	for (i=0;i<1024;i++) ;
	//writeData(~nBitmapDot[i]);	  
}

void ssd1306_printf(unsigned char dat[])
{
	int i=0;
	int j=0;

	writeCommand(SSD1306_SETLOWCOLUMN | 0x0);  // low col = 0
    writeCommand(SSD1306_SETHIGHCOLUMN | 0x0);  // hi col = 0
    writeCommand(SSD1306_SETSTARTLINE | 0x0); // line #0
	writeCommand(0xb0);

	for (i=0;i< strlen(dat);i++)
	{
		if ((dat[i]==0x0d) ||(dat[i]==0x0a) || (dat[i]==0x0b))
			for (j=0;j<8;j++)
				writeData(au8Font8x8[j]);
		else	
			for (j=0;j<8;j++)
				writeData(au8Font8x8[(dat[i]-32)*8+j]);	
	}
	for (i=0;i<1024-8*strlen(dat);i++)
		writeData(0x00); 
}

void ssd1306_printf0()
{
	writeCommand(SSD1306_SETLOWCOLUMN | 0x0);  // low col = 0
    writeCommand(SSD1306_SETHIGHCOLUMN | 0x0);  // hi col = 0
    writeCommand(SSD1306_SETSTARTLINE | 0x0); // line #0
	writeCommand(0xb0);
}
void ssd1306_printf1(unsigned char dat[])
{
	int i=0;
	int j=0;

	for (i=0;i< strlen(dat);i++)
	{
		if ((dat[i]==0x0d) ||(dat[i]==0x0a) || (dat[i]==0x0b))
			for (j=0;j<8;j++)
				writeData(au8Font8x8[j]);
		else	
			for (j=0;j<8;j++)
				writeData(au8Font8x8[(dat[i]-32)*8+j]);	
	} 
}